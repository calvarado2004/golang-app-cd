#Default deny all traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
#Allow access to DNS on all pods, DNS is located on each nodde and also using the default kube-system service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: golang-app
spec:
  podSelector:
    matchLabels: {}
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - ipBlock:
        cidr: 192.168.121.0/24
    - ipBlock:
        cidr: 10.96.0.10/32
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
    - protocol: TCP
      port: 9253
    - protocol: TCP
      port: 9153
---
#Allow port 5432 on Pods from/to itself pods, and from network-policy: pgpool-policy from the namespace golang-app
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-from-itself-port5432
  namespace: golang-app
spec:
  podSelector:
    matchLabels:
      app: postgres
  ingress:
  - ports:
    - port: 5432
    from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          network-policy: postgres-sts
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          
  egress:
  - ports:
    - port: 5432
    to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          network-policy: postgres-sts
---
#Allow port 5432 on Pods of app: pgpool from pods on network-policy: app-golang-policy only from the namespace golang-app and allow egress traffic to network-policy: postgres-sts on namespace golang-app
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-app-golang-port5432
  namespace: golang-app
spec:
  podSelector:
    matchLabels:
      app: pgpool
  ingress:
  - ports:
    - port: 5432
    from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          network-policy: app-golang-policy
  egress:
  - ports:
    - port: 5432
    to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          network-policy: postgres-sts
---
#Allow port 8080 of app id: app-golang from anywhere and allow egress traffic to network-policy: pgpool-policy on namespace golang-app
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-to-app-golang-port8080
  namespace: golang-app
spec:
  podSelector:
    matchLabels:
      id: app-golang
  ingress:
  - ports:
    - port: 8080
  egress:
  - ports:
    - port: 5432
    to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: golang-app
      podSelector:
        matchLabels:
          network-policy: pgpool-policy
